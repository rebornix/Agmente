{
  "name": "thread_read_same_prefix_then_updates_preserves_rich_local_row",
  "threadId": "fixture-thread-1",
  "initialMessages": [
    {
      "role": "assistant",
      "content": "Completed with `repeat-with-delay` defaults (since no command was specified): 5 sequential runs, 3s delay between runs."
    },
    {
      "role": "user",
      "content": "try again, 6 times, 2s delay"
    },
    {
      "role": "assistant",
      "content": "Running the same skill again with 6 iterations and 2-second delays, using separate command calls per iteration.\nTool call: [execute] /bin/zsh -lc \"LOOP_COUNTER=1 bash -lc 'echo \\\"$LOOP_COUNTER\\\"'\"\nTool call: [execute] /bin/zsh -lc 'sleep 2'\nHalfway through and proceeding sequentially with the remaining iterations and delays.\nTool call: [execute] /bin/zsh -lc \"LOOP_COUNTER=2 bash -lc 'echo \\\"$LOOP_COUNTER\\\"'\"\nTool call: [execute] /bin/zsh -lc 'sleep 2'\nCompleted: 6 runs with 2s delay between runs.\n\nOutputs:\n1. `1`\n2. `2`\n3. `3`\n4. `4`\n5. `5`\n6. `6`",
      "segments": [
        {
          "kind": "message",
          "text": "Running the same skill again with 6 iterations and 2-second delays, using separate command calls per iteration."
        },
        {
          "kind": "toolCall",
          "text": "/bin/zsh -lc \"LOOP_COUNTER=1 bash -lc 'echo \\\"$LOOP_COUNTER\\\"'\"",
          "toolCall": {
            "toolCallId": "tc-1",
            "title": "/bin/zsh -lc \"LOOP_COUNTER=1 bash -lc 'echo \\\"$LOOP_COUNTER\\\"'\"",
            "kind": "execute",
            "status": "completed",
            "output": "1"
          }
        },
        {
          "kind": "toolCall",
          "text": "/bin/zsh -lc 'sleep 2'",
          "toolCall": {
            "toolCallId": "tc-2",
            "title": "/bin/zsh -lc 'sleep 2'",
            "kind": "execute",
            "status": "completed"
          }
        },
        {
          "kind": "message",
          "text": "Halfway through and proceeding sequentially with the remaining iterations and delays."
        },
        {
          "kind": "toolCall",
          "text": "/bin/zsh -lc \"LOOP_COUNTER=2 bash -lc 'echo \\\"$LOOP_COUNTER\\\"'\"",
          "toolCall": {
            "toolCallId": "tc-3",
            "title": "/bin/zsh -lc \"LOOP_COUNTER=2 bash -lc 'echo \\\"$LOOP_COUNTER\\\"'\"",
            "kind": "execute",
            "status": "completed",
            "output": "2"
          }
        },
        {
          "kind": "toolCall",
          "text": "/bin/zsh -lc 'sleep 2'",
          "toolCall": {
            "toolCallId": "tc-4",
            "title": "/bin/zsh -lc 'sleep 2'",
            "kind": "execute",
            "status": "completed"
          }
        },
        {
          "kind": "message",
          "text": "Completed: 6 runs with 2s delay between runs.\n\nOutputs:\n1. `1`\n2. `2`\n3. `3`\n4. `4`\n5. `5`\n6. `6`"
        }
      ]
    }
  ],
  "initialKeys": [
    { "index": 0, "key": "turn:t1:assistant:a1" },
    { "index": 1, "key": "turn:t2:user:u2" },
    { "index": 2, "key": "turn:t2:assistant:local-rich" }
  ],
  "steps": [
    {
      "kind": "thread_read",
      "preferLocalRichness": true,
      "result": {
        "thread": {
          "id": "fixture-thread-1",
          "turns": [
            {
              "id": "t1",
              "status": "completed",
              "items": [
                {
                  "type": "agent_message",
                  "id": "a1",
                  "text": "Completed with `repeat-with-delay` defaults (since no command was specified): 5 sequential runs, 3s delay between runs."
                }
              ]
            },
            {
              "id": "t2",
              "status": "completed",
              "items": [
                {
                  "type": "agent_message",
                  "id": "a-2-run",
                  "text": "Running the same skill again with 6 iterations and 2-second delays, using separate command calls per iteration."
                },
                {
                  "type": "agent_message",
                  "id": "a-2-half",
                  "text": "Halfway through and proceeding sequentially with the remaining iterations and delays."
                },
                {
                  "type": "agent_message",
                  "id": "a-2-done",
                  "text": "Completed: 6 runs with 2s delay between runs.\n\nOutputs:\n1. `1`\n2. `2`\n3. `3`\n4. `4`\n5. `5`\n6. `6`"
                },
                {
                  "type": "user_message",
                  "id": "u2",
                  "text": "try again, 6 times, 2s delay"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "kind": "thread_read",
      "preferLocalRichness": true,
      "result": {
        "thread": {
          "id": "fixture-thread-1",
          "turns": [
            {
              "id": "t1",
              "status": "completed",
              "items": [
                {
                  "type": "agent_message",
                  "id": "a1",
                  "text": "Completed with `repeat-with-delay` defaults (since no command was specified): 5 sequential runs, 3s delay between runs."
                }
              ]
            },
            {
              "id": "t2",
              "status": "completed",
              "items": [
                {
                  "type": "agent_message",
                  "id": "a-2-run",
                  "text": "Running the same skill again with 6 iterations and 2-second delays, using separate command calls per iteration."
                },
                {
                  "type": "user_message",
                  "id": "u2",
                  "text": "try again, 6 times, 2s delay"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "kind": "update",
      "method": "turn/started",
      "params": {
        "threadId": "fixture-thread-1",
        "turn": { "id": "t2" }
      }
    },
    {
      "kind": "update",
      "method": "item/agentMessage/delta",
      "params": {
        "threadId": "fixture-thread-1",
        "turnId": "t2",
        "delta": "\n\nContinuing with the remaining runs."
      }
    }
  ],
  "expectations": {
    "messageCount": 3,
    "orderedMessages": [
      {
        "role": "assistant",
        "contains": "Completed with `repeat-with-delay` defaults"
      },
      {
        "role": "user",
        "contains": "try again, 6 times, 2s delay"
      },
      {
        "role": "assistant",
        "contains": "Running the same skill again with 6 iterations"
      }
    ],
    "containsCounts": [
      {
        "role": "assistant",
        "contains": "Running the same skill again with 6 iterations and 2-second delays, using separate command calls per iteration.",
        "count": 1
      },
      {
        "role": "assistant",
        "contains": "Halfway through and proceeding sequentially with the remaining iterations and delays.",
        "count": 1
      },
      {
        "role": "assistant",
        "contains": "Completed: 6 runs with 2s delay between runs.",
        "count": 1
      },
      {
        "role": "assistant",
        "contains": "Continuing with the remaining runs.",
        "count": 1
      }
    ]
  }
}
